# RHCE

## é…ç½®ä¿¡æ¯

åœ¨ç»ƒä¹ æœŸé—´ï¼Œé™¤äº†æ‚¨å°±åä½ç½®çš„å°å¼æœºä¹‹å¤–ï¼Œè¿˜å°†ä½¿â½¤å¤šä¸ªè™šæ‹Ÿç³»ç»Ÿã€‚æ‚¨ä¸å…·æœ‰å°å¼æœºç³»ç»Ÿçš„ root è®¿
é—®æƒï¼Œä½†å…·æœ‰å¯¹è™šæ‹Ÿç³»ç»Ÿçš„å®Œæ•´ root è®¿é—®æƒã€‚
ç³»ç»Ÿä¿¡æ¯ åœ¨æœ¬ç»ƒä¹ æœŸé—´ï¼Œæ‚¨å°†æ“ä½œä¸‹åˆ—è™šæ‹Ÿç³»ç»Ÿï¼š
ç³»ç»Ÿ IP åœ°å€ Ansible â»†â¾Š
control 172.25.250.254 ansible control node
node1 172.25.250.9 ansible managed node
node2 172.25.250.10 ansible managed node
node3 172.25.250.11 ansible managed node
node4 172.25.250.12 ansible managed node
node5 172.25.250.13 ansible managed node

## è´¦æˆ·ä¿¡æ¯

**æ‰€æœ‰ç³»ç»Ÿçš„ root å¯†ç æ˜¯ flectrag**
è¯·å‹¿æ›´æ”¹ root å¯†ç ã€‚é™¤â¾®å¦æœ‰æŒ‡å®šï¼Œå¦åˆ™è¿™å°†æ˜¯â½¤äºè®¿é—®å…¶ä»–ç³»ç»Ÿå’ŒæœåŠ¡çš„å¯†ç ã€‚æ­¤å¤–ï¼Œé™¤â¾®å¦æœ‰æŒ‡
å®šï¼Œå¦åˆ™æ­¤ å¯†ç ä¹Ÿåº”â½¤äºæ‚¨åˆ›å»ºçš„æ‰€æœ‰å¸â¼¾ï¼Œæˆ–è€…ä»»ä½•éœ€è¦è®¾ç½®å¯†ç çš„æœåŠ¡ã€‚
ä¸ºâ½…ä¾¿èµ·â»…ï¼Œæ‰€æœ‰ç³»ç»Ÿä¸Šå·²é¢„è£…äº† SSH å¯†é’¥ï¼Œå…è®¸åœ¨ä¸è¾“â¼Šå¯†ç çš„å‰æä¸‹é€šè¿‡ SSH è¿›â¾ root è®¿é—®ã€‚è¯·å‹¿
å¯¹ç³»ç»Ÿä¸Šçš„ root SSH é…ç½®â½‚ä»¶è¿›â¾ä»»ä½•ä¿®æ”¹ã€‚
Ansible æ§åˆ¶èŠ‚ç‚¹ä¸Šå·²åˆ›å»ºäº†â½¤â¼¾å¸â¼¾ gregã€‚æ­¤å¸â¼¾é¢„è£…äº† SSH å¯†é’¥ï¼Œå…è®¸åœ¨ Ansible æ§åˆ¶èŠ‚ç‚¹å’Œå„
ä¸ª Ansible å—ç®¡èŠ‚ç‚¹ä¹‹é—´è¿›â¾ SSH ç™»å½•ã€‚è¯·å‹¿å¯¹ç³»ç»Ÿä¸Šçš„ greg SSH é…ç½®â½‚ä»¶è¿›â¾ä»»ä½•ä¿®æ”¹ã€‚æ‚¨å¯ä»¥ä»
root å¸â¼¾ä½¿â½¤ su è®¿é—®æ­¤â½¤â¼¾å¸â¼¾ã€‚

## **é‡è¦ä¿¡æ¯**

é™¤â¾®å¦æœ‰æŒ‡å®šï¼Œå¦åˆ™æ‚¨çš„æ‰€æœ‰â¼¯ä½œï¼ˆåŒ…æ‹¬ Ansible playbookã€é…ç½®â½‚ä»¶å’Œä¸»æœºæ¸…å•ç­‰ï¼‰åº”å½“
ä¿å­˜åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šçš„â½¬å½•/home/greg/ansible ä¸­ï¼Œå¹¶ä¸”åº”å½“å½’ greg â½¤â¼¾æ‰€æœ‰ã€‚æ‰€æœ‰
Ansible ç›¸å…³çš„å‘½ä»¤åº”å½“ç”± greg â½¤â¼¾ä» Ansible æ§åˆ¶èŠ‚ç‚¹ä¸Šçš„è¿™ä¸ªâ½¬å½•è¿â¾ã€‚

## å…¶ä»–ä¿¡æ¯

â¼€äº›ç»ƒä¹ é¡¹â½¬å¯èƒ½éœ€è¦ä¿®æ”¹ Ansible ä¸»æœºæ¸…å•ã€‚æ‚¨è¦è´Ÿè´£ç¡®ä¿æ‰€æœ‰ä»¥å‰çš„æ¸…å•ç»„å’Œé¡¹â½¬ä¿ç•™ä¸‹æ¥ï¼Œä¸ä»»
ä½•å…¶ä»–æ›´æ”¹å…±å­˜ã€‚æ‚¨è¿˜è¦æœ‰ç¡®ä¿æ¸…å•ä¸­æ‰€æœ‰é»˜è®¤çš„ç»„å’Œä¸»æœºä¿ç•™æ‚¨è¿›â¾çš„ä»»ä½•æ›´æ”¹ã€‚
ç»ƒä¹ ç³»ç»Ÿä¸Šçš„é˜²â½•å¢™é»˜è®¤ä¸ºä¸å¯â½¤ï¼ŒSELinux åˆ™å¤„äºå¼ºåˆ¶æ¨¡å¼ã€‚
å¦‚æœéœ€è¦å®‰è£…å…¶ä»–è½¯ä»¶ï¼Œæ‚¨çš„ç‰©ç†ç³»ç»Ÿå’Œ Ansible æ§åˆ¶èŠ‚ç‚¹å¯èƒ½å·²è®¾ç½®ä¸ºæŒ‡å‘ content ä¸Šçš„ä¸‹è¿°å­˜
å‚¨åº“ï¼š
â€¢ [http://content/rhel9.0/x86_64/dvd/BaseOS](http://content/rhel9.0/x86_64/dvd/BaseOS)
â€¢ [http://content/rhel9.0/x86_64/dvd/AppStream](http://content/rhel9.0/x86_64/dvd/AppStream)
â¼€äº›é¡¹â½¬éœ€è¦é¢å¤–çš„â½‚ä»¶ï¼Œè¿™äº›â½‚ä»¶å·²åœ¨ä»¥ä¸‹ä½ç½®æä¾›ï¼š
â€¢ [http://classroom/materials](http://classroom/materials)
äº§å“â½‚æ¡£å¯ä»ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ï¼š
â€¢ [http://materials/docs](http://materials/docs)
å®¹å™¨é•œåƒä»“åº“ä¿¡æ¯ï¼š[utility.lab.example.com](http://utility.lab.example.com/)
â€¢è´¦å·ï¼šadmin
â€¢å¯†ç ï¼šredhat

## ğŸ¹ é‡è¦ä¿¡æ¯

è¯·æ³¨æ„ï¼Œåœ¨è¯„åˆ†ä¹‹å‰ï¼Œæ‚¨çš„ Ansible å—ç®¡èŠ‚ç‚¹ç³»ç»Ÿå°†é‡ç½®ä¸ºè€ƒè¯•å¼€å§‹æ—¶çš„åˆå§‹çŠ¶æ€ï¼Œæ‚¨ç¼–å†™
çš„ Ansible playbook å°†é€šè¿‡ä»¥ greg â½¤â¼¾â¾ä»½ä»æ§åˆ¶èŠ‚ç‚¹ä¸Šçš„â½¬å½•/home/greg/ansible â½¬å½•
è¿â¾æ¥åº”â½¤ã€‚åœ¨ playbook è¿â¾åï¼Œç³»ç»Ÿä¼šå¯¹æ‚¨çš„å—ç®¡èŠ‚ç‚¹è¿›â¾è¯„ä¼°ï¼Œä»¥åˆ¤æ–­å®ƒä»¬æ˜¯å¦æŒ‰ç…§
è§„å®šè¿›â¾äº†é…ç½®ã€‚

# 1.å®‰è£…é…ç½® Ansible

## åœ¨ Control ä¸Šå®‰è£…é…ç½® Ansible

- å®‰è£…æ‰€éœ€è¦çš„è½¯ä»¶åŒ…

## åˆ›å»º/home/greg/ansible/inventory çš„é™æ€æ¸…å•æ–‡ä»¶

- **node1 æ˜¯ dev**
- **node2 æ˜¯ test**
- **node3,node4 æ˜¯ prod**
- **node5 æ˜¯ balancers**
- **prod æ˜¯ webservers**

## /home/greg/ansible/ansible.cfg é…ç½®æ–‡ä»¶

- **ä¸»æœºæ¸…å•æ–‡ä»¶ä¸º/home/greg/ansible/inventory**
- **playbook è§’è‰²çš„ä½ç½®åœ¨/home/greg/ansible/roles**
- **è‡ªå®šä¹‰çš„ collection ç›®å½•åœ¨/home/greg/ansible/mycollection**

```bash
è¿œç¨‹ç™»é™†
ssh greg@control
# å®‰è£…ansible
sudo yum -y install ansible-core ansible-navigator
# åˆ›å»ºâ½‚ä»¶å¤¹
mkdir -p /home/greg/ansible/roles
# åˆ‡æ¢â¼¯ä½œâ½¬å½•
cd /home/greg/ansible
# æ‹·â»‰é…ç½®â½‚ä»¶
cat /etc/ansible/ansible.cfg
ansible-config init --disabled > /home/greg/ansible/ansible.cfg
# åˆ›å»ºé›†åˆå­˜å‚¨â½¬å½•
mkdir /home/greg/ansible/mycollection
# ç¼–è¾‘é…ç½®â½‚ä»¶
vim ansible.cfg
[defaults]
inventory = /home/greg/ansible/inventory
remote_user = greg
host_key_checking = False
roles_path = /home/greg/ansible/roles:/usr/share/ansible/roles
collections_path=./mycollection/:.ansible/collections:/usr/share/ansible/collec
tions
[privilege_escalation]
become=True
# ç¡®è®¤â½£æ•ˆçš„é…ç½®â½‚ä»¶(å¿…åšæ“ä½œ)
ansible --version
ansible-galaxy list
vim /home/greg/ansible/inventory
[dev]
node1
[test]
node2
[prod]
node3
node4
[balancers]
node5
[webservers:children]
prod

# éªŒè¯ï¼š å¦‚æœå¯ä»¥pingé€šæ‰€æœ‰èŠ‚ç‚¹ï¼Œè¯æ˜é…ç½®â½‚ä»¶ã€è´¦â¼¾ã€æ¸…å•éƒ½æ²¡æœ‰é—®é¢˜ã€‚(å¿…åšæ“ä½œ)
ansible-inventory --graph
ansible all -m ping
podman login utility.lab.example.com -u admin -p redhat

##æŸ¥çœ‹å…¨éƒ¨é•œåƒ
ansible-navigator images
#éªŒè¯ï¼šæ­¤å‘½ä»¤å¯ä»¥éªŒè¯podmançš„ç™»å½•ã€æ‰§â¾ç¯å¢ƒä¸‹è½½æ­£ç¡®ï¼ŒæŸ¥çœ‹é›†åˆã€‚(å¿…åšæ“ä½œï¼Œä¸åšåå½±å“åç»­é¢˜â½¬ä½¿â½¤docä»¥åŠè·‘å‰§æœ¬)
##æµè§ˆæœ¬åœ°å®‰è£…çš„ Ansible é›†åˆ
ansible-navigator collections
```

# 2.é…ç½®ç³»ç»Ÿä½¿ç”¨é»˜è®¤å­˜å‚¨åº“

- ä½œä¸ºç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ‚¨éœ€è¦åœ¨å—ç®¡èŠ‚ç‚¹ä¸Šå®‰è£…è½¯ä»¶ã€‚
- è¯·æŒ‰ç…§æ­£â½‚æ‰€è¿°ï¼Œåˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/yum_repo.yml ï¼Œåœ¨å„ä¸ªå—ç®¡èŠ‚ç‚¹ä¸Š
- å®‰è£… yum å­˜å‚¨åº“
- å­˜å‚¨åº“ 1ï¼š
  - å­˜å‚¨åº“çš„åç§°ä¸º EX294_BASE
  - æè¿°ä¸º EX294 base software
  - åŸºç¡€ URL ä¸º http://content/rhel9.0/x86_64/dvd/BaseOS
  - GPG ç­¾åæ£€æŸ¥ä¸ºå¯â½¤çŠ¶æ€
  - GPG å¯†é’¥ URL ä¸º http://content/rhel9.0/x86_64/dvd/RPM-GPG-KEY-RPM-GPG-KEY-redhat-release
  - å­˜å‚¨åº“ä¸ºå¯â½¤çŠ¶æ€
- å­˜å‚¨åº“ 2ï¼š
  - å­˜å‚¨åº“çš„åç§°ä¸º EX294_STREAM
  - æè¿°ä¸º EX294 stream software
  - åŸºç¡€ URL ä¸º http://content/rhel9.0/x86_64/dvd/AppStream
  - GPG ç­¾åæ£€æŸ¥ä¸ºå¯â½¤çŠ¶æ€
  - GPG å¯†é’¥ URL ä¸º http://content/rhel9.0/x86_64/dvd/RPM-GPG-KEY-RPM-GPG-KEY-redhat-release
    å­˜å‚¨åº“ä¸ºå¯â½¤çŠ¶æ€

```bash
**# ç¡®è®¤å„ä¸ªå—ç®¡èŠ‚ç‚¹all
ansible-inventory --graph
# æŸ¥æ¨¡å—åç§°
ansible-doc -l | grep yum
# æŸ¥æ¨¡å—â½¤æ³•ã€‚==/EX==ï¼Œåœ¨â¼¿å†Œä¸­æœç´¢ EXAMPLE â½°ä¾‹
ansible-doc yum_repository
# ç¼–è¾‘å‰§æœ¬
#set nuï¼šæ˜¾ç¤ºè¡Œå·
#ts=2ï¼šå°†åˆ¶è¡¨ç¬¦å®½åº¦è®¾ç½®ä¸º 2 ä¸ªç©ºæ ¼
#etï¼šä½¿ç”¨æ‰©å±•æ¨¡å¼
#cucï¼šåœ¨æ’å…¥æ¨¡å¼ä¸‹ä½¿ç”¨å…‰æ ‡é”®è¿›è¡Œå‰ªåˆ‡å’Œç²˜è´´
#sw=2ï¼šå°†ç¼©è¿›å®½åº¦è®¾ç½®ä¸º 2 ä¸ªç©ºæ ¼
# autoindentï¼šè‡ªåŠ¨ç¼©è¿›
echo set nu ts=2 et cuc sw=2 autoindent > ~/.vimrc
vim /home/greg/ansible/yum_repo.yml**

---
- name: repository
  hosts: all
  tasks:
  - yum_repository:
      file: EX294_BASE
      name: EX294_BASE
      description: "EX294 base software"
      baseurl: http://content/rhel9.0/x86_64/dvd/BaseOS
      gpgcheck: yes
      gpgkey: http://content/rhel9.0/x86_64/dvd/RPM-GPG-KEY-redhat-release
      enabled: yes
  - yum_repository:
      file: EX294_STREAM
      name: EX294_STREAM
      description: "EX294 stream software"
      baseurl: http://content/rhel9.0/x86_64/dvd/AppStream
      gpgcheck: yes
      gpgkey: http://content/rhel9.0/x86_64/dvd/RPM-GPG-KEY-redhat-release
      enabled: yes

**# è¿â¾å‰§æœ¬
ansible-navigator run yum_repo.yml -m stdout(Ansibleæ–°çš„
å‰§æœ¬è¿â¾â½…å¼ï¼Œå¿…é¡»åšç¬¬â¼€é¢˜çš„44-47â¾å‘½ä»¤)
# éªŒè¯ä¸¤ä¸ªä»“åº“ï¼ˆBaseOS, AppStream, å¿…åšæ“ä½œï¼‰
# éªŒè¯ï¼šéªŒè¯æ‰€æœ‰èŠ‚ç‚¹ï¼Œè‹¥è½¯ä»¶å®‰è£…å®Œæ¯•ï¼Œè¯æ˜é…ç½®æˆåŠŸã€‚
## -aæŒ‡å®šå‘½ä»¤ yum install ftp
## -m æŒ‡å®šæ¨¡å—  shell
ansible all -a 'yum repoinfo'
ansible all -a 'yum -y install ftp'
ansible all -a 'rpm -q ftp'**
```

# 3.å®‰è£…è½¯ä»¶åŒ…

- åˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/packages.yml çš„ playbook:
  - å°† php å’Œ mariadb è½¯ä»¶åŒ…å®‰è£…åˆ° devã€ test å’Œ prod ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Š
  - å°† RPM Development Tools è½¯ä»¶åŒ…ç»„å®‰è£…åˆ° dev ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Š
  - å°† dev ä¸»æœºç»„ä¸­ä¸»æœºä¸Šçš„æ‰€æœ‰è½¯ä»¶åŒ…æ›´æ–°ä¸ºæœ€æ–°ç‰ˆæœ¬

```coffeescript
ansible-doc -l | grep yum
ansible-doc yum
vim /home/greg/ansible/packages.yml
---
- name: install1
  hosts: dev,test,prod
  tasks:
  - name: install packages
    ansible.builtin.yum:
      name: "{{ packages }}"
      state: present
    vars:
      packages:
      - php
      - mariadb
- name: install2
  hosts: dev
  tasks:
  - name: install group
    ansible.builtin.yum:
      name: "@RPM Development Tools"
      state: present
  - name: upgrade all packages
    ansible.builtin.yum:
      name: '*'
      state: latest

ansible-navigator run packages.yml -m stdout
# éªŒè¯ï¼šé€šè¿‡æŸ¥çœ‹è½¯ä»¶å®‰è£…æƒ…å†µï¼Œç¡®è®¤é¢˜â½¬æ­£ç¡®ã€‚(å¿…åšæ“ä½œ)
ansible dev,test,prod -a 'rpm -q php mariadb'
ansible dev -a 'yum grouplist'
###æ˜¾ç¤º
...
Installed Groups:
RPM Development Tools
...

ansible dev -a 'yum update'

```

# 4ã€ä½¿â½¤ RHEL ç³»ç»Ÿâ»†â¾Š ***

- ä½¿â½¤ RHEL ç³»ç»Ÿâ»†â¾Š
- å®‰è£… RHEL ç³»ç»Ÿâ»†â¾Šè½¯ä»¶åŒ…ï¼Œå¹¶åˆ›å»ºç¬¦åˆä»¥ä¸‹æ¡ä»¶çš„ playbook

  /home/greg/ansible/selinux.ymlï¼š

  - åœ¨æ‰€æœ‰å—ç®¡èŠ‚ç‚¹ä¸Šè¿â¾
  - ä½¿â½¤ selinux â»†â¾Š
  - é…ç½®è¯¥â»†â¾Šï¼Œé…ç½®è¢«ç®¡ç†èŠ‚ç‚¹çš„ selinux ä¸º enforcing

```coffeescript
1.yum search role
2.sudo yum -y install rhel-system-roles
3.ansible-galaxy list
4.vim ansible.cfg ##å¯ä»¥å¿½ç•¥å‰é¢åšäº†
roles_path= /home/greg/ansible/roles:/usr/share/ansible/roles
5.ansible-galaxy list
6.cp /usr/share/doc/rhel-system-roles/selinux/example/selinux-playbook.yml /home/greg/ansible/selinux.yml
## 7.vim /home/greg/ansible/selinux.yml  ##åˆ é™¤æ“ä½œ :23,30d :9,19dï¼ˆå…·ä½“å“ªä¸€è¡Œä¸ç¡®å®šï¼‰ï¼Œå¯ä»¥ä¸åˆ 
8.ansible-playbook selinux.yml
9.'grep ^SELINUX= /etc/selinux/config; getenforce' #=åé¢è¦ç©ºä¸€æ ¼
ansible all -m shell -a 'grep ^SELINUX=/etc/selinux/config; getenforce'
```

# 5ã€é…ç½® conllection **

### é…ç½® conllection

http://classroom/materials/
â–ª redhat-insights-1.0.7.tar.gz
â–ª community-general-5.5.0.tar.gz
â–ª redhat-rhel_system_roles-1.19.3.tar.gz
ä¸Šâ¾¯ 3 ä¸ªå®‰è£…åœ¨/home/greg/ansible/mycollection â½¬å½•ä¸­

```bash
1. vim requirements.yml
---
collections:
- name: http://classroom/materials/redhat-insights-1.0.7.tar.gz
- name: http://classroom/materials/community-general-5.5.0.tar.gz
- name: http://classroom/materials/redhat-rhel_system_roles-1.19.3.tar.gz
2. ansible-galaxy collection install -r requirements.yml -p /home/greg/ansible/mycollection/
# éªŒè¯(å¿…åš)
ansible-navigator collections
ansible-navigator doc community.general.filesystem -m stdout
```

# 6ã€ä½¿â½¤ Ansible Galaxy å®‰è£…â»†â¾Š *

### ä½¿â½¤ Ansible Galaxy å’Œè¦æ±‚â½‚ä»¶/home/greg/ansible/roles/requirements.yml

ä»ä»¥ä¸‹ URL ä¸‹è½½â»†â¾Šå¹¶å®‰è£…åˆ°/home/greg/ansible/roles

- **http://classroom/materials/haproxy.tar æ­¤â»†â¾Šçš„åç§°åº”å½“ä¸º balancer**
- **http://classroom/materials/phpinfo.tar æ­¤â»†â¾Šçš„åç§°åº”å½“ä¸º phpinfo**

```coffeescript
1.vim /home/greg/ansible/roles/requirements.yml
---
- src: http://classroom/materials/haproxy.tar
  name: balancer
- src: http://classroom/materials/phpinfo.tar
  name: phpinfo

2.ansible-galaxy install -r /home/greg/ansible/roles/requirements.yml

#éªŒè¯ï¼šæŸ¥çœ‹åˆ°ä¸¤ä¸ªâ»†â¾Šå³å¯ã€‚(å¿…åšæ“ä½œ)
3.ansible-galaxy list

# /home/greg/ansible/roles
...
- balancer, (unknown version)
- phpinfo, (unknown version)
...
```

# 7ã€åˆ›å»ºå’Œä½¿â½¤â»†â¾Š *****

- æ ¹æ®ä¸‹åˆ—è¦æ±‚ï¼Œåœ¨/home/greg/ansible/roles ä¸­åˆ›å»ºåä¸º apache çš„â»†â¾Šï¼š

  - httpd è½¯ä»¶åŒ…å·²å®‰è£…ï¼Œè®¾ä¸ºåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯â½¤å¹¶å¯åŠ¨
  - é˜²â½•å¢™å·²å¯â½¤å¹¶æ­£åœ¨è¿â¾ï¼Œå¹¶ä½¿â½¤å…è®¸è®¿é—® Web æœåŠ¡å™¨çš„è§„åˆ™
  - æ¨¡æ¿â½‚ä»¶ index.html.j2 å·²å­˜åœ¨ï¼Œâ½¤äºåˆ›å»ºå…·æœ‰ä»¥ä¸‹è¾“å‡ºçš„â½‚ä»¶
    - /var/www/html/index.htmlï¼š
      Welcome to {{ansible_nodename}} on {{ansible_default_ipv4.address}}

  å…¶ä¸­ï¼ŒHOSTNAME æ˜¯å—ç®¡èŠ‚ç‚¹çš„å®Œå…¨é™å®šåŸŸå,IPADDRESS åˆ™æ˜¯å—ç®¡èŠ‚ç‚¹çš„ IP åœ°å€ã€‚
- åˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/apache.yml çš„ playbookï¼š
  è¯¥ play åœ¨ webservers ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Šè¿â¾å¹¶å°†ä½¿â½¤ apache â»†â¾Š

```coffeescript
#åœ¨rolesä¸‹å¯ä»¥çœç•¥è·¯å¾„
1.ansible-galaxy role init --init-path /home/greg/ansible/roles apache
2.ansible-galaxy list
3.vim roles/apache/tasks/main.yml
---
- name: Install Apache
  ansible.builtin.yum:
    name: httpd
    state: latest

- name: Start httpd
  ansible.builtin.systemd:
    name: httpd
    state: started
    enabled: yes

- name: Start firewalld
  ansible.builtin.systemd:
    name: firewalld
    state: started
    enabled: yes

- name: Start apache
  ansible.posix.firewalld:
# æ³¨æ„é˜²â½•å¢™ä¸­ApacheæœåŠ¡åä¸æ˜¯httpd
    service: http
    permanent: yes
    state: enabled
    immediate: yes
- template: # path = roles/apache/templates/
    src: index.html.j2
    dest: /var/www/html/index.html

4.vim roles/apache/templates/index.html.j2
Welcome to {{ ansible_nodename }} on {{ ansible_default_ipv4.address }}
6.vim /home/gregp/ansible/apache.yml
---
- name: webservers role
  hosts: webservers
  roles:
  - apache
7. ansible-navigator run apache.yml -m stdout
8.ansible webservers --list-hosts

##éªŒè¯
curl http://node3
curl http://node4
```

# 8.ä» Ansible Galaxy ä½¿â½¤â»†â¾Š

- æ ¹æ®ä¸‹åˆ—è¦æ±‚ï¼Œåˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/roles.yml çš„ playbookï¼š

  - 1.playbook ä¸­åŒ…å«â¼€ä¸ª playï¼Œè¯¥ play åœ¨ balancers ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Šè¿â¾å¹¶å°†ä½¿â½¤
    balancer â»†â¾Šã€‚

    - æ­¤â»†â¾Šé…ç½®â¼€é¡¹æœåŠ¡ï¼Œä»¥åœ¨ webservers ä¸»æœºç»„ä¸­çš„ä¸»æœºä¹‹é—´å¹³è¡¡ Web æœåŠ¡å™¨è¯·æ±‚çš„
      è´Ÿè½½ã€‚
    - æµè§ˆåˆ° balancers ä¸»æœºç»„ä¸­çš„ä¸»æœºï¼ˆä¾‹å¦‚ [http://172.25.250.13](http://172.25.250.13/) ï¼‰å°†â½£æˆä»¥
      ä¸‹è¾“å‡ºï¼š
      Welcome to [node3.lab.example.com](http://node3.lab.example.com/) on 172.25.250.11
    - é‡æ–°åŠ è½½æµè§ˆå™¨å°†ä»å¦â¼€ Web æœåŠ¡å™¨â½£æˆè¾“å‡ºï¼š
      Welcome to [node4.lab.example.com](http://node4.lab.example.com/) on 172.25.250.12
  - 2.playbook ä¸­åŒ…å«â¼€ä¸ª playï¼Œè¯¥ play åœ¨ webservers ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Šè¿â¾å¹¶å°†ä½¿â½¤
    phpinfo â»†â¾Šã€‚

    - è¯·é€šè¿‡ URL /hello.php æµè§ˆåˆ° webservers ä¸»æœºç»„ä¸­çš„ä¸»æœºå°†â½£æˆä»¥ä¸‹è¾“å‡ºï¼š
      Hello PHP World from FQDN
    - å…¶ä¸­ï¼ŒFQDN æ˜¯ä¸»æœºçš„å®Œå…¨é™å®šåç§°ã€‚
      Hello PHP World from [node3.lab.example.com](http://node3.lab.example.com/)
- å¦å¤–è¿˜æœ‰ PHP é…ç½®çš„å„ç§è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚å®‰è£…çš„ PHP ç‰ˆæœ¬ç­‰ã€‚

  - åŒæ ·ï¼Œæµè§ˆåˆ° [http://172.25.250.12/hello.php](http://172.25.250.12/hello.php) ä¼šâ½£æˆä»¥ä¸‹è¾“å‡ºï¼š
    Hello PHP World from [node4.lab.example.com](http://node4.lab.example.com/)

```coffeescript
1.vim /home/greg/ansible/roles.yml
2.å†™é…ç½®
---
- name: Use role phpinfo
  hosts: webservers
  roles:
  - phpinfo

- name: Use role balancer
  hosts: balancers
  roles:
  - balancer
3.ansible-navigator run roles.yml -m stdout

###éªŒè¯
å‘½ä»¤è¡Œè®¿é—®ï¼Œä¼šè´Ÿè½½å‡è¡¡åˆ°ä¸åŒèŠ‚ç‚¹ node3å’Œnode4
curl http://172.25.250.13
curl http://node5
vmå†…æµè§ˆå™¨è®¿é—®,åŒæ ·è´Ÿè½½å‡è¡¡åˆ°ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯ä¼šæ˜¾ç¤ºå¯¹åº”çš„phpç‰ˆæœ¬åŠå…¶ä»–ä¿¡æ¯
`http://node5/hello.php`
`http://172.25.250.12/hello.php`
```

# 9ã€åˆ›å»ºå’Œä½¿â½¤é€»è¾‘å· *****

- åˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/lv.yml çš„ playbook ï¼Œå®ƒå°†åœ¨æ‰€æœ‰å—ç®¡èŠ‚ç‚¹ä¸Šè¿â¾ä»¥

  æ‰§â¾ä¸‹åˆ—ä»»åŠ¡ï¼š
- åˆ›å»ºç¬¦åˆä»¥ä¸‹è¦æ±‚çš„é€»è¾‘å·ï¼š

  - é€»è¾‘å·åˆ›å»ºåœ¨ research å·ç»„ä¸­
  - é€»è¾‘å·åç§°ä¸º data
  - é€»è¾‘å·â¼¤â¼©ä¸º 1500MiB
- ä½¿â½¤ ext4 â½‚ä»¶ç³»ç»Ÿæ ¼å¼åŒ–é€»è¾‘å·
- å¦‚æœâ½†æ³•åˆ›å»ºè¯·æ±‚çš„é€»è¾‘å·â¼¤â¼©ï¼Œåº”æ˜¾â½°é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä¸”åº”æ”¹ä¸ºä½¿â½¤â¼¤â¼© 800MiBã€‚
  Could not create logical volume of that size
- å¦‚æœå·ç»„ research ä¸å­˜åœ¨ï¼Œåº”æ˜¾â½°é”™è¯¯ä¿¡æ¯
  Volume group done not exist
- ä¸è¦ä»¥ä»»ä½•â½…å¼æŒ‚è½½é€»è¾‘å·

```coffeescript
1.æŸ¥è¯¢æ‰‹å†Œå‘½ä»¤ ansible-navigator doc community.general.lvol -m stdout
       ansible-navigator doc community.general.filesystem -m stdout
       ansible-doc debug
       ansible-doc  stat

2.å†™é…ç½®ï¼š vim /home/greg/ansible/lv.yml
---
- name: Create LVM
  hosts: all
  tasks:
  - block:
    - name: lv 1500M
      community.general.lvol:
        vg: research
        lv: data
        size: 1500
    - name: Create ext4
      community.general.filesystem:
        fstype: ext4
        dev: /dev/research/data

    rescue:
    - name: Could not create lvm
      ansible.builtin.debug:
        msg: Could not create logical volume of that size
    - name: lv 800M
      community.general.lvol:
        vg: research
        lv: data
        size: 800
    - name: Create ext4
      community.general.filesystem:
        fstype: ext4
        dev: /dev/research/data
    when: ansible_lvm.vgs.research is defined
  - debug:
      msg: Volume group done not exist
    when: ansible_lvm.vgs.research is not defined

3.æ‰§è¡Œ
ansible-navigator run /home/greg/ansible/lv.yml -m stdout
4.éªŒè¯
ansible all -m shell -a 'lvs'
æ˜¾ç¤ºæ­£å¸¸
ansible all -m shell -a 'blikid /dev/research/data'
åªæœ‰ä¸€å·æœºæ˜¾ç¤ºnon-zero return code
```

# 10.ç”Ÿæˆä¸»æœºæ–‡ä»¶

- å°†â¼€ä¸ªåˆå§‹æ¨¡æ¿â½‚ä»¶ä» http://classroom/materials/hosts.j2

  ä¸‹è½½åˆ°/home/greg/ansible
- å®Œæˆè¯¥æ¨¡æ¿ï¼Œä»¥ä¾¿â½¤å®ƒâ½£æˆä»¥ä¸‹â½‚ä»¶ï¼š

  é’ˆå¯¹æ¯ä¸ªæ¸…å•ä¸»æœºåŒ…å«â¼€â¾å†…å®¹ï¼Œå…¶æ ¼å¼ä¸/etc/hosts ç›¸åŒ
- å°†â¼€ä¸ªå‰§æœ¬ä» http://classroom/materials/hosts.yml
  ä¸‹è½½åˆ°/home/greg/ansible ï¼Œ

  å®ƒå°†ä½¿â½¤æ­¤æ¨¡æ¿åœ¨ dev ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Šâ½£æˆâ½‚ä»¶/etc/myhostsã€‚

  è¯¥ playbook è¿â¾å dev ä¸»æœºç»„ä¸­ä¸»æœºä¸Šçš„â½‚ä»¶/etc/myhosts åº”é’ˆå¯¹æ¯ä¸ªå—ç®¡ä¸»æœºåŒ…å«â¼€â¾å†…å®¹ï¼š

```coffeescript
##æŸ¥çœ‹æ“ä½œ
ansible dev -m debug -a 'var=groups'
ansible dev -m debug -a "var=groups['all']"

1.wget http://classroom/materials/hosts.j2
2.vim hosts.j2
æ·»åŠ ï¼š
{% for i in groups.all %}
{{ hostvars[i].ansible_facts.default_ipv4.address }} {{
hostvars[i].ansible_facts.nodename }} {{ hostvars[i].ansible_facts.hostname }}
{% endfor %}

3. vim hosts.yml
---
- name: gen host file
  hosts: all
  tasks:
  - name: Template a file to /etc/myhosts
    template:
      src: /home/greg/ansible/hosts.j2
      dest: /etc/myhosts
    when: inventory_hostname in groups.dev

4.æ‰§è¡Œ ansible-navigator run hosts.yml -m stdout
5.éªŒè¯ ansible dev -m shell -a 'cat /etc/myhosts'

```

# 11.ä¿®æ”¹æ–‡ä»¶å†…å®¹

- æŒ‰ç…§ä¸‹â½…æ‰€è¿°ï¼Œåˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/issue.yml çš„ playbook:

  - è¯¥ playbook å°†åœ¨æ‰€æœ‰æ¸…å•ä¸»æœºä¸Šè¿â¾
  - è¯¥ playbook ä¼šå°†/etc/issue çš„å†…å®¹æ›¿æ¢ä¸ºä¸‹â½…æ‰€â½°çš„â¼€â¾â½‚æœ¬ï¼š
    - åœ¨ dev ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Šï¼Œè¿™â¾â½‚æœ¬æ˜¾â½°ä¸ºï¼š Development
    - åœ¨ test ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Šï¼Œè¿™â¾â½‚æœ¬æ˜¾â½°ä¸ºï¼š Test
    - åœ¨ prod ä¸»æœºç»„ä¸­çš„ä¸»æœºä¸Šï¼Œè¿™â¾â½‚æœ¬æ˜¾â½°ï¼šProductio

  ```coffeescript
  æŸ¥çœ‹
  [greg@control ansible]$ ansible dev -m debug -a 'var=inventory_hostname'
  [greg@control ansible]$ ansible dev -m debug -a 'var=groups'
  [greg@control ansible]$ ansible dev -m debug -a 'var=groups.dev'
  [greg@control ansible]$ ansible-doc copy
  [greg@control ansible]$ ansible-doc stat

  1. vim /home/greg/ansible/issue.yml
  ---
  - name: modify file
    hosts: all
    tasks:
    - name: Content 1
      ansible.builtin.copy:
        content: 'Development'
        dest: /etc/issue
      when: inventory_hostname in groups.dev
    - name: Content 2
      ansible.builtin.copy:
        content: 'Test'
        dest: /etc/issue
      when: inventory_hostname in groups.test
    - name: Content 3
      ansible.builtin.copy:
        content: 'Production'
        dest: /etc/issue
      when: inventory_hostname in groups.prod

  2. ansible-navigator run issue.yml -m stdout

  # éªŒè¯(å¿…åšæ“ä½œ)
  [greg@control ansible]$ ansible dev -a 'cat /etc/issue'
  [greg@control ansible]$ ansible test -a 'cat /etc/issue'
  [greg@control ansible]$ ansible prod -a 'cat /etc/issue'
  ```

  # 12ã€åˆ›å»º Web å†…å®¹â½¬å½•

  æŒ‰ç…§ä¸‹â½…æ‰€è¿°ï¼Œåˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/webcontent.yml çš„ playbookï¼š


  - è¯¥ playbook åœ¨ dev ä¸»æœºç»„ä¸­çš„å—ç®¡èŠ‚ç‚¹ä¸Šè¿â¾
  - åˆ›å»ºç¬¦åˆä¸‹åˆ—è¦æ±‚çš„â½¬å½•/webdevï¼š
    - æ‰€æœ‰è€…ä¸º webdev ç»„
    - å…·æœ‰å¸¸è§„æƒé™ï¼š owner=read+write+executeï¼Œ
      group=read+write+executeï¼Œ other=read+execute
    - æƒé™ï¼šè®¾ç½®ç»„ ID
  - â½¤ç¬¦å·é“¾æ¥å°†/var/www/html/webdev é“¾æ¥åˆ°/webdev
  - åˆ›å»ºâ½‚ä»¶/webdev/index.html ï¼Œå…¶ä¸­åŒ…å«å¦‚ä¸‹æ‰€â½°çš„å•â¾â½‚ä»¶ï¼š Development
  - åœ¨ dev ä¸»æœºç»„ä¸­ä¸»æœºä¸Šæµè§ˆæ­¤â½¬å½•ï¼ˆä¾‹å¦‚ [http://172.25.250.9/webdev/](http://172.25.250.9/webdev/) ï¼‰å°†â½£æˆ
    ä»¥ä¸‹è¾“å‡ºï¼š
    Development

  ```coffeescript
  ###æŸ¥çœ‹
  ansible-doc file
  ansible-doc copy
  ansible dev -a 'ls -ldZ /var/www/html'

  1.å†™é…ç½®
  vim /home/greg/ansible/webcontent.yml
  2.
  ---
  - name: Create Web Directory
    hosts: dev
    roles:
    - apache
    tasks:
    - name: Create directory
      ansible.builtin.file:
        path: /webdev
        state: directory
        group: webdev
        mode: '2775'
    - name: Create link
      ansible.builtin.file:
        src: /webdev
        dest: /var/www/html/webdev
        state: link
    - name: Copy content
      ansible.builtin.copy:
        content: 'Development'
        dest: /webdev/index.html
        setype: httpd_sys_content_t

  3.è¿è¡Œ
  ansible-navigator run webcontent.yml -m stdout
  ##éªŒè¯
  4.curl http://node1/webdev/
  å‡ºç°Development
  ```

  # 13.ç”Ÿæˆç¡¬ä»¶æŠ¥å‘Š

  - åˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/hwreport.yml çš„ playbook ï¼Œ

    å®ƒå°†åœ¨æ‰€æœ‰å—ç®¡èŠ‚ç‚¹ä¸Šâ½£æˆå«æœ‰ä»¥ä¸‹ä¿¡æ¯çš„è¾“å‡ºâ½‚ä»¶/root/hwreport.txtï¼š

    - æ¸…å•ä¸»æœºåç§°
    - ä»¥ MB è¡¨â½°çš„æ€»å†…å­˜â¼¤â¼©
    - BIOS ç‰ˆæœ¬
    - ç£ç›˜è®¾å¤‡ vda çš„â¼¤â¼©
    - ç£ç›˜è®¾å¤‡ vdb çš„â¼¤â¼©
    - è¾“å‡ºâ½‚ä»¶ä¸­çš„æ¯â¼€â¾å«æœ‰â¼€ä¸ª key=value å¯¹
  - æ‚¨çš„ playbook åº”å½“ï¼š

    - ä» [http://classroom/materials/hwreport.empty](http://classroom/materials/hwreport.empty) ä¸‹è½½â½‚ä»¶ï¼Œå¹¶å°†å®ƒä¿å­˜ä¸º
      /root/hwreport.txt
    - ä½¿â½¤æ­£ç¡®çš„ä¸º/root/hwreport.txt
    - å¦‚æœç¡¬ä»¶é¡¹ä¸å­˜åœ¨ï¼Œç›¸å…³çš„å€¼åº”è®¾ä¸º NONE

  ```coffeescript
  ##æŸ¥çœ‹
  [greg@control ansible]$ ansible all -m setup | grep mem
  [greg@control ansible]$ ansible all -m setup | grep bios
  [greg@control ansible]$ ansible all -m setup -a 'filter=*device*'

  1.curl http://materials/hwreport.empty
  2. vim /home/greg/ansible/hwreport.yml
  ---
  - name: Hardware report
    hosts: all
    tasks:
    - name: Download hwreport
      ansible.builtin.get_url:
    url: http://materials/hwreport.empty
    dest: /root/hwreport.txt
    - name: Report 1
      ansible.builtin.lineinfile:
    path: /root/hwreport.txt
    regexp: '^HOST='
    line: HOST={{ inventory_hostname }}
    - name: Report 2
      ansible.builtin.lineinfile:
    path: /root/hwreport.txt
    regexp: '^MEMORY='
    line: MEMORY={{ ansible_memtotal_mb }}
    - name: Report 3
      ansible.builtin.lineinfile:
          path: /root/hwreport.txt
    regexp: '^BIOS='
    line: BIOS={{ ansible_bios_version }}
    - name: Report 4
      ansible.builtin.lineinfile:
    path: /root/hwreport.txt
    regexp: '^DISK_SIZE_VDA='
    line: DISK_SIZE_VDA={{ ansible_devices.vda.size }}
    - name: Report 5
      ansible.builtin.lineinfile:
    path: /root/hwreport.txt
    regexp: '^DISK_SIZE_VDB='
    line: DISK_SIZE_VDB={{ ansible_devices.vdb.size | default('NONE', true) }}

  ##è¿è¡Œ
  ansible-navigator run hwreport.yml -m stdout
  # éªŒè¯ï¼š æ”¶é›†åˆ°çš„æŠ¥å‘Šåº”å’Œå„ä¸ªä¸»æœºçš„äº‹å®å¯¹â½ç»“æœâ¼€è‡´å³å¯ï¼Œè¯·â¾ƒâ¾æ ¸å¯¹ã€‚(å¿…åšæ“ä½œ)
  ansible all -a 'cat /root/hwreport.txt'
  ```

  # 14.åˆ›å»ºå¯†ç åº“

  æŒ‰ç…§ä¸‹â½…æ‰€è¿°ï¼Œåˆ›å»ºâ¼€ä¸ª Ansible åº“æ¥å­˜å‚¨â½¤â¼¾å¯†ç ï¼š

  - åº“åç§°ä¸º/home/greg/ansible/locker.yml
  - åº“ä¸­å«æœ‰ä¸¤ä¸ªå˜é‡ï¼Œåç§°å¦‚ä¸‹ï¼š
    - pw_developer ï¼Œå€¼ä¸º Imadev
    - pw_manager ï¼Œå€¼ä¸º Imamgr
  - â½¤äºåŠ å¯†å’Œè§£å¯†è¯¥åº“çš„å¯†ç ä¸º whenyouwishuponastar
    - å¯†ç å­˜å‚¨åœ¨â½‚ä»¶/home/greg/ansible/secret.txt ä¸­

  ```coffeescript
  1.vim ansible.cfg
  2.æ”¹æ–‡ä»¶
  vault_password_file = /home/greg/ansible/secret.txt
  3. echo  whenyouwishuponastar > /home/greg/ansible/secret.txt
  4. ansible-vault create /home/greg/ansible/locker.yml
  ---
  pw_developer: Imadev
  pw_manager: Imamgr

  5.ansible-vault view /home/greg/ansible/locker.yml
  pw_developer: Imadev
  pw_manager: Imamgr

  #éªŒè¯ï¼šæ ¹æ®æ¨èæŒ‡ä»¤éªŒè¯åˆ°â½‚ä»¶å†…å®¹è¢«åŠ å¯†ï¼Œä¸”å¯ä»¥é€šè¿‡é…ç½®â½‚ä»¶secret.txtâ½‚ä»¶â¾ƒåŠ¨è§£å¯†å³å¯ã€‚
  (å¿…åšæ“ä½œ)
  [greg@control ansible]$ cat /home/greg/ansible/locker.yml

  æ•ˆæœï¼š
  $ANSIBLE_VAULT;1.1;AES256
  38636666623761326536363836663066646336656361663664653235333961306634313939326631
  3038366162383733643633383935663431376163646639350a393436663566366631303064653933
  6337303063633334336262313065363336363033646164626236323964333535346665353464313
  6162383733353561640a383333623137646565666636363064343361346537396633653234306263
  33326138366135383430643763653931663738656633393933343466616235333631383431373135
  666161303763323761383731343138373166653730613932343
  ```

  # 15ã€åˆ›å»ºâ½¤â¼¾å¸â¼¾

  - **ä» [http://classroom/materials/user_list.yml](http://classroom/materials/user_list.yml) ä¸‹è½½è¦åˆ›å»ºçš„â½¤â¼¾çš„åˆ—è¡¨ï¼Œå¹¶å°†å®ƒä¿å­˜åˆ°/home/greg/ansible**
  - **åœ¨æœ¬æ¬¡ç»ƒä¹ ä¸­ä½¿â½¤åœ¨å…¶ä»–ä½ç½®åˆ›å»ºçš„å¯†ç åº“/home/greg/ansible/locker.ymlã€‚**

    **åˆ›å»ºåä¸º/home/greg/ansible/users.yml çš„ playbook ï¼Œä»â½½æŒ‰ä»¥ä¸‹æ‰€è¿°åˆ›å»ºâ½¤â¼¾å¸â¼¾ï¼š**

    - **èŒä½æè¿°ä¸º developer çš„â½¤â¼¾åº”å½“ï¼š**
      - åœ¨ dev å’Œ test ä¸»æœºç»„ä¸­çš„å—ç®¡èŠ‚ç‚¹ä¸Šåˆ›å»º
      - ä» pw_developer å˜é‡åˆ†é…å¯†ç 
      - å¯†ç æœ€â¼¤æœ‰æ•ˆæœŸ 30 å¤©
      - æ˜¯è¡¥å……ç»„ devops çš„æˆå‘˜
    - **èŒä½æè¿°ä¸º manager çš„â½¤â¼¾åº”å½“ï¼š**
      - åœ¨ prod ä¸»æœºç»„ä¸­çš„å—ç®¡èŠ‚ç‚¹ä¸Šåˆ›å»º
      - pw_manager å˜é‡åˆ†é…å¯†ç 
      - å¯†ç æœ€â¼¤æœ‰æ•ˆæœŸ 30 å¤©
      - æ˜¯è¡¥å……ç»„ opsmg r çš„æˆå‘˜
    - **å¯†ç é‡‡â½¤ sha512 å“ˆå¸Œæ ¼å¼ã€‚**
    - **æ‚¨çš„ playbook åº”èƒ½å¤Ÿåœ¨æœ¬æ¬¡ç»ƒä¹ ä¸­ä½¿â½¤åœ¨å…¶ä»–ä½ç½®åˆ›å»ºçš„åº“å¯†ç â½‚ä»¶
      /home/greg/ansible/secret.txt æ­£å¸¸è¿â¾ã€‚**

  ```coffeescript
  1.wget http://classroom/materials/user_list.yml
  2.cat user_list.yml
  3.vim /home/greg/ansible/users.yml
  ---
  - name: Create User1
    hosts: dev,test
    vars_files:
    - /home/greg/ansible/locker.yml
    - /home/greg/ansible/user_list.yml
    tasks:
    - name: Add group1
      group:
    name: devops
    state: present
    - name: Add user1
      user:
    name: "{{ item.name }}"
    groups: devops
    password: "{{ pw_developer | password_hash('sha512') }}"
    password_expire_max: "{{ item.password_expire_max }}"
      loop: "{{ users }}"
      when: item.job == 'developer'

  - name: Create User2
    hosts: prod
    vars_files:
    - /home/greg/ansible/locker.yml
    - /home/greg/ansible/user_list.yml
    tasks:
    - name: Add group2
      group:
    name: opsmgr
    state: present
    - name: Add user2
      user:
    name: "{{ item.name }}"
    groups: opsmgr
    password: "{{ pw_manager | password_hash('sha512') }}"
    password_expire_max: "{{ item.password_expire_max }}"
      loop: "{{ users }}"
      when: item.job == 'manager'

  4.è¿è¡Œansible-navigator run users.yml -m stdout

  # éªŒè¯ï¼š ç¡®ä¿ devï¼Œtest ä¸Šæœ‰bobã€fred ä¸”ä¸é¢˜â½¬è¦æ±‚â¼€è‡´(å¿…åšæ“ä½œ)
  [greg@control ansible]$ ansible dev,test -m shell -a 'id bob; id sally; id
  fred'

  # ç¡®ä¿ pord(node3 node4) ä¸Šæœ‰ sally ä¸”ä¸é¢˜â½¬è¦æ±‚â¼€è‡´(å¿…åšæ“ä½œ)
  [greg@control ansible]$ ansible prod -m shell -a 'id fred; id bob; id sally'

  [greg@control ansible]$ ssh bob@172.25.250.9
  bob@172.25.250.9\'s password: `Imadev`
  <Ctrl-D>
  [greg@control ansible]$ ssh sally@172.25.250.12
  sally@172.25.250.12\'s password: `Imamgr`
  <Ctrl-D>
  ```

  # 16.æ›´æ–° Ansible åº“çš„å¯†é’¥

  **æŒ‰ç…§ä¸‹â½…æ‰€è¿°ï¼Œæ›´æ–°ç°æœ‰ Ansible åº“çš„å¯†é’¥ï¼š**

  - ä» http://classroom/materials/salaries.yml ä¸‹è½½ Ansible åº“åˆ°/home/greg/ansible
  - å½“å‰çš„åº“å¯†ç ä¸º insecure8sure
  - æ–°çš„åº“å¯†ç ä¸º bbs2you9527
  - åº“ä½¿å¯†ç ä¿æŒåŠ å¯†çŠ¶æ€

  ```coffeescript
  1.wget http://classroom/materials/salaries.yml

  2. ansible-vault rekey --ask-vault-pass salaries.yml
  Vault password: `insecure8sure`
  New Vault password: `bbs2you9527`
  Confirm New Vault password: `bbs2you9527`
  Rekey successful

  3.ansible-vault view salaries.yml
  Vault password: `bbs2you9527`
  haha

  # éªŒè¯ï¼š â½¤æ–°å¯†ç éªŒè¯æ˜¯å¦å¯ä»¥è§£å¯†æŸ¥çœ‹å†…å®¹ã€‚(å¿…åšæ“ä½œ)
  ansible-vault view --ask-vault-pass salaries.yml
  Vault password: `bbs2you9527`
  haha
  ```

  # 17.é…ç½® cron ä½œä¸š

  - åˆ›å»ºâ¼€ä¸ªåä¸º/home/greg/ansible/cron.yml çš„ playbook :

    - è¯¥ playbook åœ¨ test ä¸»æœºç»„ä¸­çš„å—ç®¡èŠ‚ç‚¹ä¸Šè¿â¾
    - é…ç½® cron ä½œä¸šï¼Œè¯¥éš” 2 åˆ†é’Ÿè¿â¾å¹¶æ‰§â¾ä»¥ä¸‹å‘½ä»¤ï¼š logger "EX200 in progress"ï¼Œ

      ä»¥â½¤â¼¾ natasha â¾ä»½è¿â¾

    ```coffeescript
    1. ansible-doc -l |grep cron
    2. ansible-doc cron
    3. vim /home/greg/ansible/cron.yml
    ---
    - name: cron
      hosts: test
      tasks:
      - name: cron job
        cron:
          name: "cron job1"
          minute: "*/2"
          job: 'logger "EX200 in progress"'
          user: natasha
    4.è¿è¡Œ ansible-navigator run cron.yml -m stdout

    # éªŒè¯ï¼šé€šè¿‡crontab -l -u natashaå‘½ä»¤éªŒè¯ä»»åŠ¡æ˜¯å¦å­˜åœ¨å¹¶æ­£ç¡®ã€‚(å¿…åšæ“ä½œ)
    [greg@control ansible]$ ansible test -a 'crontab -l -u natasha'

    æ•ˆæœï¼š
    node2 | CHANGED | rc=0 >>
    #Ansible: check dirs
    */2 * * * * logger "EX200 in progress"

    ```

æ‰€æœ‰ç³»ç»Ÿçš„ root å¯†ç æ˜¯ flectrag
è¯·å‹¿æ›´æ”¹ root å¯†ç ã€‚é™¤â¾®å¦æœ‰æŒ‡å®šï¼Œå¦åˆ™è¿™å°†æ˜¯â½¤äºè®¿é—®å…¶ä»–ç³»ç»Ÿå’ŒæœåŠ¡çš„å¯†ç ã€‚æ­¤å¤–ï¼Œé™¤â¾®å¦æœ‰æŒ‡
å®šï¼Œå¦åˆ™æ­¤ å¯†ç ä¹Ÿåº”â½¤äºæ‚¨åˆ›å»ºçš„æ‰€æœ‰å¸â¼¾ï¼Œæˆ–è€…ä»»ä½•éœ€è¦è®¾ç½®å¯†ç çš„æœåŠ¡ã€‚
ä¸ºâ½…ä¾¿èµ·â»…ï¼Œæ‰€æœ‰ç³»ç»Ÿä¸Šå·²é¢„è£…äº† SSH å¯†é’¥ï¼Œå…è®¸åœ¨ä¸è¾“â¼Šå¯†ç çš„å‰æä¸‹é€šè¿‡ SSH è¿›â¾ root è®¿é—®ã€‚è¯·å‹¿
å¯¹ç³»ç»Ÿä¸Šçš„ root SSH é…ç½®â½‚ä»¶è¿›â¾ä»»ä½•ä¿®æ”¹ã€‚
Ansible æ§åˆ¶èŠ‚ç‚¹ä¸Šå·²åˆ›å»ºäº†â½¤â¼¾å¸â¼¾ gregã€‚æ­¤å¸â¼¾é¢„è£…äº† SSH å¯†é’¥ï¼Œå…è®¸åœ¨ Ansible æ§åˆ¶èŠ‚ç‚¹å’Œå„
ä¸ª Ansible å— ç®¡èŠ‚ç‚¹ä¹‹é—´è¿›â¾ SSH ç™»å½•ã€‚è¯·å‹¿å¯¹ç³»ç»Ÿä¸Šçš„ greg SSH é…ç½®â½‚ä»¶è¿›â¾ä»»ä½•ä¿®æ”¹ã€‚æ‚¨å¯ä»¥ä»
root å¸â¼¾ä½¿â½¤ su è®¿é—®æ­¤ â½¤â¼¾å¸â¼¾ã€‚
